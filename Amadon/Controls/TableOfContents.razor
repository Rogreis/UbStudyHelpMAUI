@using Amadon.Services;
@using AmadonStandardLib.Classes;
@using AmadonStandardLib.Helpers;
@using AmadonStandardLib.InterchangeData;
@using AmadonStandardLib.UbClasses;
@using Blazorise.TreeView



@*  Based in:
    https://blazorise.com/docs/extensions/treeview
*@

@if (TocGotFromData)
{
    <Tabs SelectedTab="@selectedTab" SelectedTabChanged="@OnSelectedTabChanged">
        <Items>
            <Tab Name="Primary">@titlePrimary</Tab>
            <Tab Name="Secondary">@titleSecondary</Tab>
        </Items>
        <Content>
            <TabPanel Name="Primary">
                <TreeView @ref="@treeViewPrimary" Nodes="ItemsPrimary"
                      GetChildNodes="@(item => item.Children)"
                      HasChildNodes="@(item => item.Children?.Any() == true)"
                      @bind-SelectedNode="SelectedNode"
                      @bind-ExpandedNodes="expandedNodesPrimary"
                >
                    <NodeContent>
                        @context.Text
                    </NodeContent>
                </TreeView>
            </TabPanel>
            <TabPanel Name="Secondary">
                <TreeView @ref="@treeViewSecondary" Nodes="ItemsSecondary"
                      GetChildNodes="@(item => item.Children)"
                      HasChildNodes="@(item => item.Children?.Any() == true)"
                      @bind-SelectedNode="selectedNode"
                      @bind-ExpandedNodes="expandedNodesSecondary">
                    <NodeContent>
                        @context.Text
                    </NodeContent>
                </TreeView>
            </TabPanel>
        </Content>
    </Tabs>

}



@code {


    private Task OnSelectedNodeChanged(ItemForToc item)
    {
        //if (item is null)
        //{
        //    throw new ArgumentNullException(nameof(item));
        //}
        // Perform actions when a TreeView node is selected
        //Console.WriteLine($"Selected node: {item.Text}");
        return Task.CompletedTask;
    }


    private string selectedTab = "Primary";

    TreeView<ItemForToc> treeViewPrimary;
    TreeView<ItemForToc> treeViewSecondary;

    string titlePrimary = "Primary";
    string titleSecondary = "Secondary";

    TOCdata data = new TOCdata();
    bool TocGotFromData = false;
    IEnumerable<ItemForToc> ItemsPrimary = new ItemForToc[0];
    IEnumerable<ItemForToc> ItemsSecondary = new ItemForToc[0];

    IList<ItemForToc> expandedNodesPrimary = new List<ItemForToc>();
    IList<ItemForToc> expandedNodesSecondary = new List<ItemForToc>();
    private ItemForToc selectedNode;
    private ItemForToc SelectedNode 
    { 
        get
        {
            return selectedNode;
        }
        set
        {
            ItemForToc item = value;
            AmadonEvents.NewTocEntry(item.Entry);
            selectedNode = value;
        }
    }

    public async Task UpdateAll()
    {
        // Both translation must be in the translations to show
        // IF not, a default value is set
        if (StaticObjects.Parameters.LanguageIDLeftTranslation > 0 &&
            !StaticObjects.Parameters.TranslationsToShowId.Contains(StaticObjects.Parameters.LanguageIDLeftTranslation))
        {
            StaticObjects.Parameters.LanguageIDLeftTranslation = 0;
        }
        if (StaticObjects.Parameters.LanguageIDRightTranslation > 0 &&
            !StaticObjects.Parameters.TranslationsToShowId.Contains(StaticObjects.Parameters.LanguageIDRightTranslation))
        {
            // It is mandatory to have at least one translation in the translations to show list
            StaticObjects.Parameters.LanguageIDRightTranslation = StaticObjects.Parameters.TranslationsToShowId[0];
        }

        // Needs update?
        data.UpdateTocId1 = data.TranslationId1 != StaticObjects.Parameters.LanguageIDLeftTranslation;
        data.UpdateTocId2 = data.TranslationId1 != StaticObjects.Parameters.LanguageIDRightTranslation;


        if (!data.UpdateTocId1 && data.UpdateTocId2)
        {
            // Both toc already created
            return;
        }
        data.TranslationId1 = StaticObjects.Parameters.LanguageIDLeftTranslation;
        data.TranslationId2 = StaticObjects.Parameters.LanguageIDRightTranslation;
        data = await TOC_Service.GetTocTable(data);
        ItemsPrimary = data.TocId1;
        ItemsSecondary = data.TocId2;
        titlePrimary = data.TitleTranslation1;
        titleSecondary = data.TitleTranslation2;
        TocGotFromData = true;
        StateHasChanged();
    }

    private Task OnSelectedTabChanged(string name)
    {
        selectedTab = name;
        return Task.CompletedTask;
    }




    public void RazorComponentShown(string componentId)
    {
        if (componentId == AmadonEvents.ControlToc)
        {
            Task task = UpdateAll();
            task.Wait();
        }
    }



    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateAll();
            AmadonEvents.OnRazorComponentShown += RazorComponentShown;
        }
    }


}
