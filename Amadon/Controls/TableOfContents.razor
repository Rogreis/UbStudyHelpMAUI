@using Amadon.Services;
@using AmadonStandardLib.Classes;
@using AmadonStandardLib.Helpers;
@using AmadonStandardLib.InterchangeData;
@using AmadonStandardLib.UbClasses;
@using Blazorise.TreeView



@*  Based in:
    https://blazorise.com/docs/extensions/treeview
*@

@if (TocGotFromData)
{
    <TreeView @ref="@treeViewPrimary" Nodes="ItemsPrimary"
          GetChildNodes="@(item => item.Children)"
          HasChildNodes="@(item => item.Children?.Any() == true)"
          @bind-SelectedNode="SelectedNode"
          @bind-ExpandedNodes="expandedNodesPrimary">
        <NodeContent>
            @context.Text
        </NodeContent>
    </TreeView>
}



@code {

    TreeView<ItemForToc> treeViewPrimary;

    // Output data
    public List<ItemForToc>? TocId1 { get; set; } = null;

    public string TitleTranslation1 { get; set; } = "Primary";


    TOCdata data = new TOCdata();
    bool TocGotFromData = false;

    IEnumerable<ItemForToc> ItemsPrimary = new ItemForToc[0];

    IList<ItemForToc> expandedNodesPrimary = new List<ItemForToc>();

    private ItemForToc selectedNode;
    private ItemForToc SelectedNode 
    { 
        get
        {
            return selectedNode;
        }
        set
        {
            ItemForToc item = value;
            AmadonEvents.NewTocEntry(item.Entry);
            selectedNode = value;
        }
    }

    public async Task UpdateAll()
    {
        // Both translation must be in the translations to show
        // IF not, a default value is set
        if (StaticObjects.Parameters.TranslationForTableOfContents < 0 ||
            !StaticObjects.Parameters.TranslationsToShowId.Contains(StaticObjects.Parameters.TranslationForTableOfContents))
        {
            StaticObjects.Parameters.TranslationForTableOfContents = 0;
        }

        // Needs update?
        data.UpdateTocId1 = data.TranslationId1 != StaticObjects.Parameters.TranslationForTableOfContents;

        if (!data.UpdateTocId1)
        {
            // TOC already created
            return;
        }
        data.TranslationId1 = StaticObjects.Parameters.TranslationForTableOfContents;
        data = await TOC_Service.GetTocTable(data);
        ItemsPrimary = data.TocId1;
        TocGotFromData = true;
        StateHasChanged();
    }


    private void TranslationTocChanged()
    {
        Task.Run(async () => await UpdateAll()).GetAwaiter().GetResult();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        AmadonEvents.OnTranslationTocChanged += TranslationTocChanged;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await UpdateAll();
        }
    }

}
