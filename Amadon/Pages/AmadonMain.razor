@page "/"
@using Amadon.Controls;
@using AmadonBlazorLibrary.Data;
@using AmadonStandardLib.Classes;
@using AmadonStandardLib.Helpers;

<div class="container-fluid bg-dark text-white">
    @if (InitializationStatus == Status.ReadyToGo)
    {
        <LeftColumn @ref=LeftControl ControlName="settings"></LeftColumn>
        <BookText></BookText>
    }

    <Modal @ref="modalRef" Animated="animation" AnimationDuration="animationDuration" Border="Border.Is4.Rounded.Warning">
        <ModalContent Size="@modalSize" Centered="@centered">
            <ModalHeader Class="bg-primary">
                <ModalTitle>
                    <Icon Name="IconName.Edit" />
                    Employee edit
                </ModalTitle>
                <CloseButton />
            </ModalHeader>
            <ModalBody MaxHeight="@maxHeight" Class="bg-dark text-white">

                @switch (InitializationStatus)
                {
                    case Status.NotInitialized:
                    case Status.LogInitialized:
                    case Status.ParametersInitialized:
                        <LogControl @ref="logViewer"></LogControl>
                        break;
                    case Status.RepositoryInitialized:
                        <TranslationsChoice></TranslationsChoice>
                        break;
                }

            </ModalBody>

            <ModalFooter Class="bg-dark">
                    <Button Color="Color.Secondary" Clicked="@HideModalCancel">Cancel</Button>
                    <Button Color="Color.Primary" Clicked="@HideModalOk">Save Changes</Button>
            </ModalFooter>
        </ModalContent>
    </Modal>

    <Modal @ref="modalRef2" Animated="animation" AnimationDuration="animationDuration">
        <ModalContent Size="ModalSize.Small" Centered>
            <ModalHeader Class="bg-primary">
                <ModalTitle>
                    Hello
                </ModalTitle>
                <CloseButton />
            </ModalHeader>
            <ModalBody Class="bg-dark text-white">
                I am a second modal with some message.
            </ModalBody>
            <ModalFooter Class="bg-dark">
                <Button Color="Color.Secondary" Clicked="@HideModal2">Close</Button>
            </ModalFooter>
        </ModalContent>
    </Modal>

    <Alert Color="Color.Success" @bind-Visible="@alertVisible">
        <AlertDescription>
            Lorem ipsum dolor sit amet, consectetur adipisicing elit.
        </AlertDescription>
        <AlertMessage>
            Inicialization ok.
        </AlertMessage>
        <CloseButton />
    </Alert>

</div>


@code {

    enum Status
    {
        NotInitialized,
        LogInitialized,
        ParametersInitialized,
        RepositoryInitialized,
        TranslationsInitialized,
        ReadyToGo,
        Error
    }

    // Local blazor components
    private LeftColumn LeftControl;
    private Modal modalRef;
    private Modal modalRef2;
    private LogControl logViewer;

    // Page status control
    private Status InitializationStatus = Status.NotInitialized;

    // Modal parameters
    private bool centered = false;
    private ModalSize modalSize = ModalSize.Default;
    private int? maxHeight = null;
    private bool animation = true;
    private int animationDuration = 150;

    // Alert parameters
    bool alertVisible = false;

    #region Modal routines
    private Task ShowModal(ModalSize modalSize, int? maxHeight = null, bool centered = false)
    {
        this.centered = centered;
        this.modalSize = modalSize;
        this.maxHeight = maxHeight;

        return modalRef.Show();
    }

    private Task HideModalCancel()
    {
        return modalRef.Hide();
    }

    private Task HideModalOk()
    {
        InitializationStatus = Status.Error;
        return modalRef.Hide();
    }


    private Task ShowModal2()
    {
        return modalRef2.Show();
    }


    private Task HideModal2()
    {
        return modalRef2.Hide();
    }

    private void HandleSendMessage(string Message)
    {
        //if (Status == Status.InitializedFinished) return;
        logViewer.AppendLogText(Message);
        StateHasChanged();
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        EventsControl.SendMessage += HandleSendMessage;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await ShowModal(ModalSize.Large, 50, true);
            await DoInitialization();
        }
    }
    #endregion


    #region Initialization

    private async Task<bool> DoInitializeTranslations()
    {
        Diagnostic diagnostic = await InitializationService.InitLeftTranslation(StaticObjects.Parameters.LanguageIDLeftTranslation);
        if (diagnostic.IsError) HandleSendMessage(diagnostic.Message);
        diagnostic = await InitializationService.InitMiddleTranslation(StaticObjects.Parameters.LanguageIDMiddleTranslation);
        if (diagnostic.IsError) HandleSendMessage(diagnostic.Message);
        diagnostic = await InitializationService.InitRightTranslation(StaticObjects.Parameters.LanguageIDRightTranslation);
        if (diagnostic.IsError) HandleSendMessage(diagnostic.Message);
        return true;
    }


    private async Task<Status> DoInitialization(bool recreate = false)
    {
        bool errorOcurred = false, ret = false;

        while(!errorOcurred)
        {
            switch (InitializationStatus)
            {
                case Status.NotInitialized:
                    ret = await InitializationService.InitLooger();
                    if (!ret)
                    {
                        HandleSendMessage("Init logger failed");
                        HandleSendMessage("App cannot be started.");
                        InitializationStatus= Status.Error;
                        errorOcurred = true;
                    }
                    else
                    {
                        InitializationStatus = Status.LogInitialized;
                    }
                    break;
                case Status.LogInitialized:
                    ret = await InitializationService.InitParameters();
                    if (!ret)
                    {
                        HandleSendMessage("Parameters initialization failed");
                        HandleSendMessage("App cannot be started.");
                        InitializationStatus = Status.Error;
                        errorOcurred = true;
                    }
                    else
                    {
                        InitializationStatus = Status.ParametersInitialized;
                    }
                    break;
                case Status.ParametersInitialized:
                    ret = await InitializationService.InitRepositories(recreate);
                    if (!ret)
                    {
                        HandleSendMessage("Repositories initialization failed");
                        HandleSendMessage("App cannot be started.");
                        InitializationStatus = Status.Error;
                        errorOcurred = true;
                    }
                    else
                    {
                        InitializationStatus = Status.RepositoryInitialized;
                    }
                    break;

                case Status.RepositoryInitialized:
                    ret = await InitializationService.InitTranslations();
                    if (!ret)
                    {
                        HandleSendMessage("Translations list initialization failed");
                        HandleSendMessage("App cannot be started.");
                        InitializationStatus = Status.Error;
                        errorOcurred = true;
                    }
                    else
                    {
                        InitializationStatus = Status.TranslationsInitialized;
                        alertVisible = true;
                        StateHasChanged();
                        return InitializationStatus;
                    }
                    break;
            }
        }

        return InitializationStatus;

        //ret = await DoInitializeTranslations();
        //HandleSendMessage("Init ok");
        //StaticObjects.InitializationDone = true;

    }


    #endregion


}
